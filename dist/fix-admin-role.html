<!DOCTYPE html>
<html>
<head>
  <title>Fix Admin Role - S21 ROOFER</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
      text-align: center;
    }
    .container {
      background: #2a2a2a;
      padding: 40px;
      border-radius: 12px;
      border: 2px solid #ef4444;
    }
    h1 { color: #ef4444; margin-top: 0; }
    button {
      background: #ef4444;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      margin: 10px;
    }
    button:hover {
      background: #dc2626;
    }
    .success { color: #10b981; font-size: 20px; margin: 20px 0; }
    .info { color: #60a5fa; margin: 20px 0; }
    .warning { color: #f59e0b; margin: 20px 0; }
    pre {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      text-align: left;
      overflow-x: auto;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ†Ô∏è Emergency Admin Role Fix</h1>
    <p class="info">This page will manually fix your admin role in localStorage</p>

    <div id="status">
      <p>Current Status: <span id="currentStatus">Checking...</span></p>
    </div>

    <button onclick="fixAdminRole()">FIX MY ADMIN ROLE NOW</button>
    <button onclick="location.href='/'">Go to App</button>

    <div id="result" style="margin-top: 30px;"></div>
  </div>

  <script>
    function checkStatus() {
      const tokenStr = localStorage.getItem('s21_auth_token');
      if (!tokenStr) {
        document.getElementById('currentStatus').innerHTML = '<span style="color: #f59e0b">Not logged in</span>';
        return null;
      }

      try {
        const token = JSON.parse(tokenStr);
        const role = token.user?.role || 'unknown';
        const email = token.user?.email || 'unknown';

        if (role === 'admin') {
          document.getElementById('currentStatus').innerHTML = `<span style="color: #10b981">‚úÖ Already admin (${email})</span>`;
        } else {
          document.getElementById('currentStatus').innerHTML = `<span style="color: #ef4444">‚ùå Current role: ${role} (${email})</span>`;
        }
        return token;
      } catch (e) {
        document.getElementById('currentStatus').innerHTML = '<span style="color: #ef4444">Error reading token</span>';
        return null;
      }
    }

    function fixAdminRole() {
      const tokenStr = localStorage.getItem('s21_auth_token');
      if (!tokenStr) {
        document.getElementById('result').innerHTML = `
          <p class="warning">‚ùå You're not logged in!</p>
          <p>Please log in first, then come back to this page.</p>
        `;
        return;
      }

      try {
        // Parse the current token
        const authData = JSON.parse(tokenStr);

        // Get the user object
        const user = authData.user;

        // Store original for comparison
        const originalRole = user.role;

        // Fix the role to admin
        user.role = 'admin';

        // Update the token
        authData.user = user;

        // Save back to localStorage
        localStorage.setItem('s21_auth_token', JSON.stringify(authData));

        // Also update s21_auth_user if it exists
        const authUserStr = localStorage.getItem('s21_auth_user');
        if (authUserStr) {
          try {
            const authUser = JSON.parse(authUserStr);
            authUser.role = 'admin';
            localStorage.setItem('s21_auth_user', JSON.stringify(authUser));
          } catch (e) {
            // ignore
          }
        }

        document.getElementById('result').innerHTML = `
          <div class="success">
            <p>‚úÖ SUCCESS! Your role has been updated!</p>
          </div>
          <div class="info">
            <p><strong>Changed:</strong></p>
            <p>From: ${originalRole} ‚Üí To: admin üëë</p>
            <p>Email: ${user.email}</p>
          </div>
          <div class="warning">
            <p><strong>Next Step:</strong></p>
            <p>1. Click "Go to App" button above</p>
            <p>2. Look in the sidebar for "Admin Panel" with a shield icon</p>
            <p>3. Click it to access all user conversations!</p>
          </div>
        `;

        // Update status
        setTimeout(() => {
          checkStatus();
        }, 100);

      } catch (error) {
        document.getElementById('result').innerHTML = `
          <p class="warning">‚ùå Error: ${error.message}</p>
          <p>Please try logging out and logging back in.</p>
        `;
      }
    }

    // Check status on load
    checkStatus();
  </script>
</body>
</html>
