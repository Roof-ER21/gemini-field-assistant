# PDF Storm Damage Report Service

Professional PDF report generation for storm damage history - better than HailTrace's $40 reports.

## Overview

The PDF Report Service generates comprehensive, insurance-grade storm damage history reports with:

- **Professional Design**: Clean, corporate layout with branded colors
- **Comprehensive Data**: Both NOAA and IHM data sources
- **Damage Risk Score**: Prominent 0-100 risk assessment with color coding
- **Storm Timeline**: Detailed chronological table of all events
- **Insurance Evidence**: NOAA certification and data source attribution
- **Customizable**: Rep contact info and company branding

## Features

### 1. Header Section
- Company logo (SA21 badge)
- Report title: "STORM DAMAGE HISTORY REPORT"
- Unique report ID (e.g., SR-ABC123-XYZ)
- Generation timestamp

### 2. Property Information
- Full address
- GPS coordinates (lat/lng)
- Search radius
- Data sources used

### 3. Damage Score Section (Prominent)
- **Large Score Display**: 0-100 score with color coding
- **Risk Level Badge**: Low/Moderate/High/Critical
- **Risk Summary**: Auto-generated explanation
- **Factors Breakdown**:
  - Total events count
  - Maximum hail size
  - Recent activity (12 months)
  - Severe events (1.5"+)
  - Cumulative exposure

### 4. Executive Summary
- Total storm events within radius
- Largest recorded hail size
- Most recent event date
- Severe event count
- Historical data coverage (years)

### 5. Storm Event Timeline
- Chronological table with:
  - Date
  - Event type (Hail/Wind/Tornado)
  - Size/Magnitude
  - Severity (color coded)
  - Data source (NOAA/IHM)
  - Distance from property
- Auto-pagination for large datasets
- Alternating row colors for readability

### 6. Evidence Section
- NOAA certification statement
- IHM data attribution
- Insurance claim suitability notice
- Professional disclaimer

### 7. Footer (on every page)
- "Generated by SA21 Storm Intelligence"
- Rep contact info (if provided)
- Page numbers
- Confidentiality notice

## Color Scheme

Professional blues and grays with risk-level color coding:

- **Primary Blue**: #1e3a8a (Navy)
- **Secondary Gray**: #475569 (Slate)
- **Accent Blue**: #0ea5e9 (Sky)
- **Critical**: #dc2626 (Red) - Score 76-100
- **High**: #f97316 (Orange) - Score 51-75
- **Moderate**: #eab308 (Yellow) - Score 26-50
- **Low**: #22c55e (Green) - Score 0-25

## API Endpoint

### POST `/api/hail/generate-report`

Generate and download a PDF storm damage report.

#### Request Body

```json
{
  "address": "123 Main St, Dallas, TX 75001",
  "lat": 32.7767,
  "lng": -96.7970,
  "radius": 50,
  "events": [
    {
      "id": "ihm-1",
      "date": "2024-05-15T14:30:00Z",
      "latitude": 32.7800,
      "longitude": -96.8000,
      "hailSize": 2.0,
      "severity": "severe",
      "source": "IHM",
      "distanceMiles": 2.3
    }
  ],
  "noaaEvents": [
    {
      "id": "noaa-1",
      "date": "2024-04-12T15:00:00Z",
      "latitude": 32.7800,
      "longitude": -96.7900,
      "magnitude": 1.5,
      "eventType": "hail",
      "location": "Dallas County",
      "distanceMiles": 1.5
    }
  ],
  "damageScore": {
    "score": 72,
    "riskLevel": "High",
    "factors": {
      "eventCount": 6,
      "maxHailSize": 2.0,
      "recentActivity": 3,
      "cumulativeExposure": 8.5,
      "severityDistribution": {
        "severe": 3,
        "moderate": 2,
        "minor": 1
      },
      "recencyScore": 18.5
    },
    "summary": "High risk area with 6 recorded hail events...",
    "color": "#f97316"
  },
  "repName": "John Smith",
  "repPhone": "(555) 123-4567",
  "repEmail": "john@example.com",
  "companyName": "SA21 Storm Intelligence"
}
```

#### Required Fields

- `address` (string): Property address
- `lat` (number): Latitude
- `lng` (number): Longitude
- `radius` (number): Search radius in miles
- `damageScore` (object): Complete damage score result

#### Optional Fields

- `events` (array): IHM hail events (default: [])
- `noaaEvents` (array): NOAA storm events (default: [])
- `repName` (string): Sales rep name
- `repPhone` (string): Sales rep phone
- `repEmail` (string): Sales rep email
- `companyName` (string): Company name (default: "SA21 Storm Intelligence")

#### Response

Returns a PDF file for download with:
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename="Storm_Report_[address]_[timestamp].pdf"`

#### Example cURL

```bash
curl -X POST http://localhost:3000/api/hail/generate-report \
  -H "Content-Type: application/json" \
  -d '{
    "address": "123 Main St, Dallas, TX",
    "lat": 32.7767,
    "lng": -96.7970,
    "radius": 50,
    "damageScore": {
      "score": 72,
      "riskLevel": "High",
      "factors": {...},
      "summary": "...",
      "color": "#f97316"
    }
  }' \
  --output storm-report.pdf
```

## Frontend Integration

### Example React Component

```typescript
import { useState } from 'react';

function GenerateReportButton({ searchResults }) {
  const [loading, setLoading] = useState(false);

  const handleGenerateReport = async () => {
    setLoading(true);

    try {
      const response = await fetch('/api/hail/generate-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          address: searchResults.address,
          lat: searchResults.lat,
          lng: searchResults.lng,
          radius: searchResults.radius,
          events: searchResults.events,
          noaaEvents: searchResults.noaaEvents,
          damageScore: searchResults.damageScore,
          repName: 'John Smith',
          repPhone: '(555) 123-4567',
          repEmail: 'john@example.com',
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to generate report');
      }

      // Download the PDF
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Storm_Report_${Date.now()}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      console.log('✅ Report generated successfully!');
    } catch (error) {
      console.error('❌ Report generation failed:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleGenerateReport}
      disabled={loading}
    >
      {loading ? 'Generating...' : 'Generate PDF Report'}
    </button>
  );
}
```

## Testing

### Run Test Script

```bash
npx tsx server/services/test-pdf-report.ts
```

This will generate a sample PDF at `/Users/a21/gemini-field-assistant/test-storm-report.pdf`.

### Manual Testing

1. Start the server: `npm run server:dev`
2. Use Postman or curl to POST to `/api/hail/generate-report`
3. Verify PDF downloads correctly
4. Open PDF and check:
   - Professional appearance
   - All sections present
   - Data accuracy
   - Footer on all pages
   - Page numbers correct

## Technical Details

### Dependencies

- **pdfkit**: PDF generation library
- **@types/pdfkit**: TypeScript type definitions

Installed via:
```bash
npm install pdfkit @types/pdfkit --save
```

### Files

- `/server/services/pdfReportService.ts`: Main PDF generation service
- `/server/routes/hailRoutes.ts`: API endpoint (POST /api/hail/generate-report)
- `/server/services/test-pdf-report.ts`: Test script

### PDF Specifications

- **Size**: Letter (8.5" x 11")
- **Margins**: 50pt all sides
- **Fonts**: Helvetica, Helvetica-Bold, Helvetica-Oblique
- **Max Table Rows per Page**: ~25 (auto-paginated)

## Comparison to HailTrace

| Feature | SA21 Storm Report | HailTrace |
|---------|------------------|-----------|
| **Price** | FREE | $40/report |
| **Data Sources** | NOAA + IHM | Proprietary |
| **Damage Score** | YES (0-100) | NO |
| **Risk Assessment** | Full breakdown | Basic |
| **Timeline Detail** | Comprehensive table | Limited |
| **Customization** | Rep branding | None |
| **NOAA Certified** | YES | Unknown |
| **Real-time** | YES | Delayed |

## Future Enhancements

Potential improvements:

1. **Company Logo Upload**: Replace placeholder with actual logo
2. **Map Visualization**: Include static map with event markers
3. **Weather Radar Images**: Embed radar snapshots
4. **Multi-address Batch**: Generate reports for multiple properties
5. **Email Delivery**: Auto-send to customer email
6. **White-label Branding**: Complete company customization
7. **Digital Signature**: Rep signature field
8. **QR Code**: Link to online version
9. **Satellite Imagery**: Before/after property photos
10. **Insurance Form Integration**: Pre-fill claim forms

## Support

For questions or issues:
- Check logs for error messages
- Verify all required fields in request
- Ensure damage score calculation is complete
- Test with sample data first

## License

Internal use only - SA21 Storm Intelligence
